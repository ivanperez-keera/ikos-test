name: Check IKOS on mac

on: [push, pull_request]

  # env:
  #   DEVELOPER_DIR: /Applications/Xcode_15.4.app/Contents/Developer


jobs:
  Install:

    runs-on: macos-latest

    steps:
    - uses: actions/checkout@v4
    - name: What xcode are you using
      run: |
        xcode-select -p
    - name: Update Homebrew
      run: |
        brew update --preinstall
    - name: Install Homebrew dependencies
      run: |
        env HOMEBREW_NO_AUTO_UPDATE=1 brew install llvm@14
        echo 'LDFLAGS="-L/opt/homebrew/opt/llvm@14/lib/c++ -Wl,-rpath,/opt/homebrew/opt/llvm@14/lib/c++"' >> $GITHUB_ENV
        echo "LDFLAGS=-L/opt/homebrew/opt/llvm@14/lib" >> $GITHUB_ENV
        echo "CFLAGS=--verbose -I$(xcrun --show-sdk-path)/usr/include -I/opt/homebrew/opt/llvm@14/include" >> $GITHUB_ENV
        echo "CPPFLAGS=--verbose -I$(xcrun --show-sdk-path)/usr/include -I/opt/homebrew/opt/llvm@14/include" >> $GITHUB_ENV
        echo "CPATH=$(xcrun --show-sdk-path)/usr/include" >> $GITHUB_ENV
        echo "SDKROOT=$(xcrun --show-sdk-path)" >> $GITHUB_ENV
        echo "/opt/homebrew/opt/llvm@14/bin" >> $GITHUB_PATH
    - name: Show variables
      run: |
        echo "CPP Flags are"
        echo "${{ env.CPPFLAGS }}"
        echo "End of echo"
        pwd
        # sudo xcode-select -s /Applications/Xcode_15.4.app/
        # # echo "CPATH=$(xcrun --show-sdk-path)/usr/include" >> $GITHUB_ENV
        # # echo "SDKROOT=$(xcrun --show-sdk-path)" >> $GITHUB_ENV
        # # echo "$CPATH"
        # # echo "$SDKROOT"
        env HOMEBREW_NO_AUTO_UPDATE=1 brew install --build-from-source ./apron.rb
        env HOMEBREW_NO_AUTO_UPDATE=1 brew install --build-from-source ./ikos.rb || cat /Users/runner/Library/Logs/Homebrew/ikos/04.make
